<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='util.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='eventHITW.js') }}"></script>

    <title>Events</title>
  </head>


  <body>
    <table class="table table-hover" id="event_table" id="event_table">
      <thead>
        <tr>
          <th id="event_title">Event Title</th>
          <th id="event_location">Event Location</th>
          <th id="event_time">Event Time</th>
          <th id="event_date">Event Date</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </body>
</html>

<script>
var currently_editing_event = false;
var events = [];

$(document).ready(function() {
  $.ajax({
    type: "GET",
    url: '/get_all_events/',
    contentType: "application/json",
    dataType: "json",
    success: function(data) {
      events = parse_event_from_json(data);
      events.forEach(function(event_) {
        event_id =       event_.get_event_id()
        event_title =    event_.get_event_title()
        event_location = event_.get_event_location()
        event_time =     event_.get_event_time()
        event_date =     event_.get_event_date()

        $('#event_table > tbody').append(
          '<tr>'+
            '<td>' + event_title + '</td>' +
            '<td>' + event_location + '</td>' +
            '<td>' + event_time + '</td>' +
            '<td>' + event_date + '</td>' +
            '<td><button id="edit_event_button">Edit Event</button></td>' +
            '<td><button id="remove_event">Remove Event</button></td>' +
            '<td>' +
              '<form id="show_results_for_event" action="{{url_for("results")}}" method="GET">' +
                '<input type="hidden" id="results_for_event_id" name="results_for_event">' +
                '<input type="submit" value="Results">' +
                '</form>' +
            '</td>'+
          '</tr>')
      });

      // Add listener.
      $("button").click(function() {
        if (this.id == 'edit_event_button') {
          var index = $(this).closest('tr').index();
          update_event(events[index]);
        }
        if (this.id == 'remove_event') {
          var index = $(this).closest('tr').index();
          remove_event(events[index]);
        }
      });

      $("#show_results_for_event").submit(function(e) {
        var form = $("#show_results_for_event");
        var index = $(this).closest('tr').index();

        // Pass the event id via GET request to next page.
        var event = events[index];
        var event_id = event.get_event_id();
        $("input[id=results_for_event_id]").val(event_id);
      });
    },
    failure: function() {
      alert("Something went wrong.")
    }
  });
});



function update_event(hitw_event) {
  display_edit_area(function() {
    fill_html_with_event(hitw_event);
  });
}

function fill_html_with_event(hitw_event) {
  var editing_event = hitw_event
  $('#event_title').val(hitw_event.get_event_title());
  $('#event_location').val(hitw_event.get_event_location());
  $('#event_time').val(hitw_event.get_event_time());
  $('#event_date').val(hitw_event.get_event_date());

  $('button').click(function() {
    if (this.id == 'submit_event_edit') {
      var updated_event_title = $('#event_title').val();
      var updated_event_location = $('#event_location').val();
      var updated_event_time = $('#event_time').val();
      var updated_event_date = $('#event_date').val();

      // Send edited event info to server.
      send_update_to_server(editing_event, updated_event_title, updated_event_location, updated_event_time, updated_event_date);
    }
    if (this.id == 'cancel_editing') {
      remove_edit_view();
    }
  });
};


function remove_event(event) {
  if (confirm("Are you sure you want to delete " +
  event.get_event_location() + " on " +
  event.get_event_date() + " at " +
  event.get_event_time() + "?")) {
    $.ajax({
      type: "DELETE",
      url: '/edit_event/' + event.get_event_id(),
      success: function(data) {
        remove_edit_view();
        alert("Event has been removed.");
        location.reload(true);
      },
      failure: function() {
        alert("Something went wrong.");
      }
    });

  }
}


function display_edit_area(callback) {
  if (!currently_editing_event) {
      $.ajax({
        type: 'GET',
        url: "/edit_event_view/",
        success: function (data) {
          $('body').append(data);
          currently_editing_event = true;
          callback()
        },
        dataType: 'html'
      });
  }
}

function remove_edit_view() {
  $('#edit_event_view').remove();
  currently_editing_event = false;
}

function send_update_to_server(old_event, event_title, event_location, event_time, event_date) {
  var jsonData = {
    "title": event_title,
    "location": event_location,
    "time": event_time,
    "date": event_date,
    "identifier": old_event.get_event_id() // Use the id of the old event as ids cannot be edited.
  }
  var data = JSON.stringify(jsonData);

  $.ajax({
    type: "PUT",
    url: '/edit_event/' + old_event.get_event_id(),
    contentType: "application/json",
    data: data,
    success: function(data) {
      remove_edit_view();
      alert("Event has been updated.");
      location.reload(true);
    },
    failure: function() {
      alert("Something went wrong.");
    }
  });

}
</script>
