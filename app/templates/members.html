<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='member.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='util.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='common.js') }}"></script>


    <title>Members</title>
  </head>


  <body>
    <table class="table table-hover" id="member_table">
      <thead>
        <tr>
          <th id="member_f_name">Firstname</th>
          <th id="member_l_name">Lastname</th>
          <th id="member_handicap">Handicap</th>
          <th id="update_member">Update Member</th>
          <th id="remove_member">Remove Member</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <!-- Add Event Modal -->
    <div class="modal fade" id="editMemberModal" role="dialog">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Edit Member</h4>
          </div>
          <div class="modal-body">
            <table>
              <tr>
                <td>
                  Firstname
                  <input type="text" class="form-control" id="member_f_name">
                </td>
              </tr>
              <tr>
                <td>
                  Lastname
                  <input type="text" class="form-control" id="member_l_name">
                </td>
              </tr>
              <tr>
                <td>
                  Handicap
                  <input type="text" class="form-control" id="member_handicap" value="mm:hh">
                </td>
              </tr>
            </table>
          </div>
          <div class="modal-footer">
            <input class="btn btn-default"
              type="button" id="add_event_button" value="Update">

            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
var currently_updating_user = false;
var members = [] // All the members currently in the table.

$(document).ready(function() {
  ajaxGET_get_all_members(
    function successful(data) {

      members = parse_member_from_json(data);
      members.forEach(function(member){
        // Append member to html.
        add_member_to_html(member, true);
      });
    },
    function failure() {
      alert('Something went wrong!');
    }
  );

  // Add listener.
  $("button").click(function() {
    if (this.id == 'update_button') {
      var index = $(this).closest('tr').index();
      update_member(members[index]);
    }
    if (this.id == 'delete_member') {
      var index = $(this).closest('tr').index();
      delete_member(members[index]);
    }
  });
});


function add_member_to_html(member, present_admin_tools) {
  if (present_admin_tools) {
    $('#member_table > tbody').append(
      '<tr>' +
        '<td>' + member.get_member_f_name() + '</td>' +
        '<td>' + member.get_member_l_name() + '</td>' +
        '<td>' + member.get_member_handicap() + '</td>' +
        '<td><button id="update_button" onClick="update_button_click(this);" >Edit Member</button></td>' +
        '<td><button id="delete_member">Remove Member</button></td>' +
      '</tr>');
  }
  else {
    $('#member_table > tbody').append(
      '<tr>' +
        '<td>' + member.get_member_f_name() + '</td>' +
        '<td>' + member.get_member_l_name() + '</td>' +
        '<td>' + member.get_member_handicap() + '</td>' +
      '</tr>');
  }
}

// Handler for a click on update button
function update_button_click(button) {
  var index = $(button).closest('tr').index();
  update_member(members[index]);
}
function update_member(member) {
  display_update_area(function() {
    fill_html_with_member(member)
  });
}

function delete_member(member) {
  if (confirm("Are you sure you want to delete " + member.get_member_f_name() + " " + member.get_member_l_name())) {
    $(function () {
      $.ajax({
        type: "DELETE",
        url: '/edit_member/' + member.get_member_id(),
        success: function(data) {
          alert(member.get_member_f_name() + " " + member.get_member_l_name() + " has been removed.")
          location.reload(true)
        },
        failure: function() {
          alert("Something went wrong.")
        }
      });
    });
  }
}

function display_update_area(callback) {
  if (!currently_updating_user) {
    $(function () {
      $.ajax({
        type: 'GET',
        url: "/update_member/",
        success: function (data) {
          $('body').append(data);
          currently_updating_user = true;
          callback()
        },
        dataType: 'html'
      });
    });
  }
}


function fill_html_with_member(member) {
  var editing_member = member;
  $('#member_f_name').val(editing_member.get_member_f_name());
  $('#member_l_name').val(editing_member.get_member_l_name());
  $('#member_handicap').val(editing_member.get_member_handicap());

  // Logic for updating user.
  $('button').click(  function() {
    if (this.id == 'update_member_button') {
      // Get the newly entered values.
      var updated_member_f_name =   $('#member_f_name').val();
      var updated_l_name = $('#member_l_name').val();
      var updated_member_handicap = $('#member_handicap').val();

      // Send edited info to server.
      send_update_to_server(
        editing_member,
        updated_member_f_name,
        updated_l_name,
        updated_member_handicap
      )
    }
    if (this.id == 'cancel_update') {
      remove_update_content();
    }
  });
}

function send_update_to_server(old_member, new_member_f_name, new_member_l_name, new_member_handicap) {
  var jsonData = {
    "firstname" :new_member_f_name,
    "lastname"  :new_member_l_name,
    "handicap"  :new_member_handicap,
    "identifier":old_member.get_member_id() // Use the old id, as this will never change
  };

  var data = JSON.stringify(jsonData)

  $.ajax({
    type: "PUT",
    url: '/edit_member/' + old_member.get_member_id(),
    contentType: "application/json",
    data: data,
    success: function(data) {
      remove_update_content();
      alert(new_member_f_name + " " + new_member_l_name + " has been updated.")
      location.reload(true)
    },
    failure: function() {
      alert("Something went wrong.")
    }
  });
}

function remove_update_content() {
  $('#update_member_content').remove();
  currently_updating_user = false;
}


</script>
