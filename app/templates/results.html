<!DOCTYPE html>
<html>
  <head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="../static/util.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='result.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='member.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='common.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='typeahead.js') }}"></script>

    <link rel="stylesheet" href="../static/styles/index.css">

    <title>Results</title>
  </head>
  <body>
    <button class="btn btn-default" data-toggle="modal" data-target="#addResultModal" onclick="before_result_modal()">Add Result</button>

    Member
    <input type="text" class="form-control" id="result_member_id" data-provide="typeahead">
    <table class="table table-responsive" id="result_table">
      <thead>
        <tr>
          <th>Player</th>
          <th>Current Handicap</th>
          <th>Result</th>
          <th>Remove Result</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>


    <!-- Add Member Modal -->
    <div class="modal fade" id="addResultModal" role="dialog">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Add Member</h4>
          </div>
          <div class="modal-body">
            <table>
              <tr>
                <td>
                  Member
                  <input type="text" class="form-control" id="result_member_id">
                </td>
              </tr>
              <tr>
                <td>
                  Event
                  <input type="text" class="form-control" id="result_event_id">
                </td>
              </tr>
              <tr>
                <td>
                  Score
                  <input type="text" class="form-control" id="result_score_id">
                </td>
              </tr>

            </table>
          </div>
          <div class="modal-footer">
            <input type="button" class="btn btn-default" id="add_member_button" value="Add Member">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script type="text/javascript">
var results = []
var members_results_map = {}
var event_id = {{ event_id }}
var members_names_for_typeahead = []

$(document).ready(function() {

  ajaxGET_results_for_event(event_id,
    function success(data) {
      // Get all the results.
      results = parse_result_from_json(data);
      results.forEach(function(result) {
        // Now get the member associated with that result.
        get_member_for_result(result,
          function(member) {
            members_results_map[member] = result;
            add_result_info_to_html(result, member);
          });
        });
      },
      function failure() { }
    );
    $("input").typeahead({
      source: members_names_for_typeahead,
      minLength: 1
    });
  }
);

function get_member_for_result(result, callback) {
    // Get the member_id and get all
    // details about that user.
    member_id = result.get_member_id();
    ajaxGET_get_member(member_id,
      function successful(data) {
        var member = new Member(data.identifier, data.firstname, data.lastname, data.handicap);
        callback(member);
      },
      function failure() { }
    );
}

function add_result_info_to_html(result, member) {
  var member_name = member.get_member_fullname();
  var current_handicap = member.get_member_handicap();

  $('#result_table > tbody').append(
    '<tr>'+
      '<td>' + member_name + '</td>' +
      '<td>' + current_handicap + '</td>' +
      '<td>' + result.get_result_score() + '</td>' +
    '</tr>')
}


function before_result_modal() {
  // Get all members from the database so we can use them for typeahead functionality.
  ajaxGET_get_all_members(
    function success(data) {
      members = parse_member_from_json(data);
      members.forEach(function(member) {
        members_names_for_typeahead.push(member.get_member_fullname());
      });
    },
    function failure() {

    }
  );
}



</script>
